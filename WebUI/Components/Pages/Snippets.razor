@page "/snippets"
@page "/snippets/{SearchQuery}"
@inject IMediator Mediator
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<MudPaper Class="pa-4 mb-4">
    <MudGrid>
        <MudItem xs="12" sm="8">
            <MudText Typo="Typo.h4">Snippets</MudText>
        </MudItem>
        <MudItem xs="12" sm="4" Class="d-flex justify-end">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenCreateDialog">New Snippet</MudButton>
        </MudItem>

        <MudItem xs="12">
            <MudTextField @bind-Value="search" Placeholder="Search title, tags or code..." Immediate="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" OnImmediateValueChanged="OnSearchChanged" />
        </MudItem>
    </MudGrid>
</MudPaper>

@if (isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}

<MudGrid Gutter="GutterSize.Small">
    @if (snippets?.Any() ?? false)
    {
        @foreach (var s in snippets)
        {
            <MudItem xs="12" sm="6" md="4">
                <SnippetCard Snippet="s" OnTogglePublic="TogglePublic" />
            </MudItem>
        }
    }
    else if (!isLoading)
    {
        <MudItem xs="12">
            <MudPaper Class="pa-6 text-center">
                <MudText>No snippets found.</MudText>
            </MudPaper>
        </MudItem>
    }
</MudGrid>

@code {
    [Parameter] public string? SearchQuery { get; set; }

    List<dynamic>? snippets;
    bool isLoading = false;
    string search = "";

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrWhiteSpace(SearchQuery))
            search = SearchQuery;
        await LoadList();
    }

    async Task LoadList()
    {
        isLoading = true;
        StateHasChanged();

        // If search text is a GUID -> load single snippet by Id
        if (!string.IsNullOrWhiteSpace(search) && Guid.TryParse(search, out var guid))
        {
            var singleRes = await Mediator.Send(new GetSnippetDetailsQuery { Id = guid });
            if (singleRes != null && singleRes.Success && singleRes.Data != null)
            {
                // wrap single result into a list so UI can render it uniformly
                snippets = new List<dynamic> { singleRes.Data };
            }
            else
            {
                // no snippet found for that guid
                snippets = new List<dynamic>();
                Snackbar.Add(singleRes?.Message ?? "Snippet not found", Severity.Warning);
            }
        }
        else if (!string.IsNullOrWhiteSpace(search))
        {
            // text search
            var searchRes = await Mediator.Send(new SearchSnippetsQuery { Query = search, Limit = 100 });
            if (searchRes != null && searchRes.Success && searchRes.Data != null)
                snippets = searchRes.Data.Cast<dynamic>().ToList();
            else
                snippets = new List<dynamic>();
        }
        else
        {
            // default list
            var listRes = await Mediator.Send(new GetSnippetListCustomQuery { Page = 1, PageSize = 24 });
            if (listRes != null && listRes.Success && listRes.Data != null)
                snippets = listRes.Data.Cast<dynamic>().ToList();
            else
                snippets = new List<dynamic>();
        }

        isLoading = false;

        // highlight after render on the client; safe to call (no-op server prerender)
        await InvokeAsync(() => JS.InvokeVoidAsync("hljs.highlightAll"));
    }

    async Task OnSearchChanged(string _)
    {
        // immediate refresh (consider debouncing client-side)
        await LoadList();
    }

    async Task OpenCreateDialog()
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Large, FullWidth = true };
        var diag = DialogService.Show<SnippetEditorDialog>("New Snippet", options);
        var res = await diag.Result;
        if (res.Data != null)
        {
            Snackbar.Add("Snippet created", Severity.Success);
            await LoadList();
        }
    }

    async Task TogglePublic(Guid id)
    {
        await Mediator.Send(new TogglePublicCommand { Id = id, IsPublic = true }); // adapt if your command ctor is different
        Snackbar.Add("Visibility toggled", Severity.Info);
        await LoadList();
    }
}
